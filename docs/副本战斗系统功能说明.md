# 副本战斗系统功能说明

## 系统概述

副本战斗系统是气运修仙游戏的核心战斗模块，提供了完整的回合制战斗体验，包括副本探索、怪物战斗、奖励获取等功能。

## 主要功能

### 1. 副本系统

#### 副本类型
- **初心者洞穴** (简单难度)
  - 需要境界：凡人
  - 体力消耗：10点
  - 层数：3层
  - 适合新手玩家探索

- **森林遗迹** (普通难度)
  - 需要境界：练气后期
  - 体力消耗：20点
  - 层数：5层
  - 更具挑战性的副本

#### 副本机制
- 每个副本包含多个层数
- 每层有不同数量和类型的怪物
- 必须击败当前层所有怪物才能进入下一层
- 完成所有层数即可获得副本完成奖励

### 2. 战斗系统

#### 回合制战斗
- 玩家和怪物轮流行动
- 支持多种战斗技能
- 实时显示血量变化
- 详细的战斗日志记录

#### 战斗技能
- **普通攻击**：基础物理攻击，无冷却时间
- **重击**：高伤害物理攻击，提高暴击率
- **法术攻击**：魔法伤害攻击
- **治疗**：恢复生命值
- **防御**：减少受到的伤害

#### 属性系统
- **生命值**：角色的血量，归零则死亡
- **物理攻击**：物理技能的伤害基础
- **法术攻击**：魔法技能的伤害基础
- **物理防御**：减少物理伤害
- **法术防御**：减少魔法伤害
- **暴击率**：造成暴击的概率
- **暴击倍数**：暴击时的伤害倍率

### 3. 怪物系统

#### 怪物类型
- **普通怪物**：基础属性，适合练级
- **精英怪物**：更高属性和奖励
- **Boss怪物**：最强属性，丰厚奖励

#### 怪物AI
- 根据血量状态选择不同行动
- 攻击性和防御性行为模式
- 智能技能选择

#### 已实现怪物
- **洞穴鼠**：最基础的怪物
- **洞穴蜘蛛**：有毒攻击的怪物
- **洞穴蝙蝠**：敏捷型怪物
- **洞穴守护者**：初心者洞穴的Boss
- **森林狼**：凶猛的野兽
- **树灵**：会治疗的魔法怪物
- **森林守护者**：精英级守护者
- **远古树人**：森林遗迹的最终Boss

### 4. 奖励系统

#### 战斗奖励
- **经验值**：击败怪物获得修炼经验
- **金币**：基础货币奖励
- **掉落物品**：随机掉落材料和装备

#### 完成奖励
- **副本完成奖励**：额外的经验和金币
- **首次通关奖励**：特殊奖励
- **难度加成**：高难度副本有更好的奖励

### 5. 体力系统

#### 体力机制
- 进入副本需要消耗体力
- 体力会随时间自动恢复
- 最大体力值：100点
- 恢复速度：1点/分钟

#### 体力管理
- 合理安排副本挑战时间
- 可通过道具快速恢复体力

## 使用指南

### 进入副本
1. 点击主界面的"副本"按钮
2. 在副本列表中选择合适的副本
3. 确认体力充足和境界要求
4. 点击"进入副本"开始探索

### 战斗操作
1. 选择合适的战斗技能
2. 观察怪物血量和状态
3. 合理使用治疗技能
4. 注意自己的血量变化

### 退出副本
- 可随时点击"退出副本"离开
- 退出后会失去当前进度
- 建议完成当前层再退出

## 技术特性

### 数据库设计
- **dungeons表**：存储副本配置
- **monsters表**：存储怪物数据
- **dungeon_instances表**：副本实例状态
- **combat_logs表**：战斗日志记录

### API接口
- `GET /api/v1/game/dungeons` - 获取副本列表
- `POST /api/v1/game/enter-dungeon` - 进入副本
- `GET /api/v1/game/dungeon-status` - 获取副本状态
- `POST /api/v1/game/combat-action` - 执行战斗行动
- `POST /api/v1/game/exit-dungeon` - 退出副本

### 客户端界面
- 副本列表显示
- 实时战斗界面
- 血量进度条
- 战斗日志窗口
- 技能按钮面板

## 平衡性设计

### 难度曲线
- 副本难度与玩家境界匹配
- 怪物属性随难度递增
- 奖励与风险成正比

### 战斗平衡
- 伤害计算考虑攻防差值
- 暴击系统增加战斗变数
- 治疗技能平衡生存能力

### 经济平衡
- 体力限制防止过度刷取
- 奖励设计鼓励挑战高难度
- 掉落率控制物品稀有度

## 未来扩展

### 计划功能
- 更多副本类型和主题
- 装备掉落和强化系统
- 组队副本功能
- 副本排行榜
- 特殊事件副本

### 优化方向
- 战斗动画效果
- 更丰富的怪物AI
- 动态难度调整
- 成就系统集成

## 开发说明

### 文件结构
```
server/core/systems/
├── combat_system.py      # 战斗核心逻辑
├── dungeon_system.py     # 副本管理系统
└── monster_system.py     # 怪物系统(待开发)

client/ui/windows/
└── dungeon_window.py     # 副本界面

shared/
├── constants.py          # 副本和怪物配置
└── schemas.py           # 数据传输模型
```

### 配置文件
- `DUNGEON_CONFIGS`：副本配置数据
- `MONSTER_CONFIGS`：怪物配置数据
- `COMBAT_SYSTEM_CONFIG`：战斗系统配置
- `DUNGEON_SYSTEM_CONFIG`：副本系统配置

### 测试工具
- `setup_dungeon_system.py`：系统初始化脚本
- `test_dungeon_system.py`：功能测试脚本

---

副本战斗系统为游戏提供了丰富的PvE内容，通过合理的难度设计和奖励机制，为玩家提供持续的挑战和成长动力。
