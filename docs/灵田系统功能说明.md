# 灵田系统功能说明

## 概述

灵田系统是气运修仙游戏的重要功能模块，为玩家提供了种植灵草、收获材料的农业玩法。通过种植不同的种子，玩家可以获得各种修炼材料，同时气运值还会影响作物的变异概率，增加游戏的趣味性和收益。

## 核心功能

### 1. 地块管理系统

#### 地块配置
- **总地块数**: 12个 (3x4网格布局)
- **初始解锁**: 4个地块
- **解锁机制**: 消耗金币和满足洞府等级要求

#### 地块解锁需求
| 地块编号 | 洞府等级要求 | 解锁费用 |
|---------|-------------|---------|
| 1-4     | 无要求      | 免费    |
| 5-6     | 4级洞府     | 500金币 |
| 7-8     | 5级洞府     | 1000金币|
| 9-10    | 6级洞府     | 2000金币|
| 11-12   | 7级洞府     | 5000金币|

#### 地块类型
| 类型 | 名称 | 成长速度 | 产量倍率 | 变异基础率 | 解锁费用 |
|------|------|---------|---------|-----------|---------|
| normal | 普通土地 | 1.0x | 1.0x | 1% | 0 |
| fertile | 肥沃土地 | 1.3x | 1.2x | 2% | 1000金币 |
| spiritual | 灵田 | 1.5x | 1.5x | 5% | 5000金币 |

### 2. 种植系统

#### 可种植作物
| 种子名称 | 成长时间 | 产量范围 | 收获物品 | 变异产物 |
|---------|---------|---------|---------|---------|
| 灵草种子 | 2小时 | 1-3个 | 灵草 | 高品质灵草、灵草精华 |
| 灵芝种子 | 6小时 | 1-2个 | 灵芝 | 千年灵芝、灵芝王 |
| 聚气草种子 | 4小时 | 2-4个 | 聚气草 | 聚气草精华、灵气结晶 |

#### 种植机制
1. **种子消耗**: 每次种植消耗1个种子
2. **成长阶段**: 种子 → 发芽 → 幼苗 → 成长 → 成熟 (5个阶段)
3. **时间计算**: 受地块类型和聚灵阵等级影响
4. **变异概率**: 基础概率 + 气运加成 + 地块加成

#### 成长速度影响因素
- **地块类型**: 不同类型地块有不同的成长速度倍率
- **聚灵阵**: 洞府聚灵阵等级提供额外成长速度加成
- **计算公式**: `实际成长时间 = 基础时间 / (地块倍率 × 聚灵阵倍率)`

### 3. 收获系统

#### 收获机制
1. **成熟判定**: 作物达到成熟阶段后可收获
2. **产量计算**: 基础产量 × 地块产量倍率
3. **变异判定**: 根据变异概率决定是否产生特殊物品
4. **自动清理**: 收获后地块自动清空，可重新种植

#### 变异系统
- **变异概率**: 地块基础变异率 + 气运加成
- **气运影响**: `(气运值 - 50) × 0.1%` 的额外变异率
- **变异效果**: 产生稀有材料，普通产量相应减少

#### 特殊状态
- **枯萎**: 超过24小时未收获有概率枯萎
- **虫害**: 成长期间有概率出现虫害
- **杂草**: 成长期间有概率出现杂草

### 4. 用户界面

#### 主界面布局
- **左侧**: 地块网格 (3x4布局)
- **右侧**: 操作面板和信息显示

#### 地块显示状态
- **未解锁**: 灰色背景，显示"未解锁"
- **空地**: 棕色背景，显示"空地 可种植"
- **成长中**: 绿色背景，显示作物名称和剩余时间
- **可收获**: 亮绿色背景，显示"可收获!"
- **枯萎**: 暗棕色背景，显示"作物枯萎"

#### 操作功能
- **种植**: 选择种子和地块进行种植
- **收获**: 点击成熟地块进行收获
- **解锁**: 点击未解锁地块进行解锁
- **刷新**: 手动刷新地块状态

## 技术实现

### 数据库结构

#### FarmPlot表
```sql
CREATE TABLE farm_plots (
    id INTEGER PRIMARY KEY,
    character_id INTEGER NOT NULL,
    plot_index INTEGER NOT NULL,
    plot_type VARCHAR(20) DEFAULT 'normal',
    is_unlocked BOOLEAN DEFAULT 0,
    seed_item_id INTEGER,
    planted_at DATETIME,
    harvest_at DATETIME,
    growth_stage INTEGER DEFAULT 0,
    is_ready BOOLEAN DEFAULT 0,
    is_withered BOOLEAN DEFAULT 0,
    has_pest BOOLEAN DEFAULT 0,
    has_weed BOOLEAN DEFAULT 0,
    mutation_chance REAL DEFAULT 0.0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### API接口

#### 获取灵田信息
- **端点**: `GET /api/v1/game/farm-info`
- **功能**: 获取角色的灵田详细信息
- **返回**: 地块状态、可用种子、统计信息等

#### 种植种子
- **端点**: `POST /api/v1/game/plant-seed`
- **参数**: `plot_index`, `seed_item_id`
- **功能**: 在指定地块种植种子

#### 收获地块
- **端点**: `POST /api/v1/game/harvest-plot`
- **参数**: `plot_index`
- **功能**: 收获指定地块的作物

#### 解锁地块
- **端点**: `POST /api/v1/game/unlock-plot`
- **参数**: `plot_index`
- **功能**: 解锁指定地块

### 客户端实现

#### FarmWindow类
- **文件位置**: `client/ui/windows/farm_window.py`
- **主要功能**: 灵田界面管理、用户交互处理
- **组件**: 地块网格、操作面板、信息显示

#### FarmPlotWidget类
- **功能**: 单个地块的显示和交互
- **状态管理**: 根据地块数据更新显示状态
- **用户交互**: 处理点击事件，触发相应操作

## 游戏平衡性

### 经济平衡
- **种子获取**: 通过商店购买或任务奖励
- **收益设计**: 投入产出比合理，鼓励长期种植
- **解锁成本**: 递增式费用，控制游戏进程

### 时间平衡
- **成长时间**: 2-6小时不等，适合不同游戏节奏
- **收获窗口**: 24小时内收获，避免过度惩罚
- **变异概率**: 低概率高收益，增加期待感

### 策略深度
- **地块选择**: 不同类型地块的成本效益分析
- **作物搭配**: 不同成长时间的作物轮作
- **气运管理**: 高气运时种植高价值作物

## 使用指南

### 新手指导
1. **初期策略**: 优先种植灵草种子，成长时间短
2. **地块解锁**: 根据洞府等级逐步解锁更多地块
3. **时间管理**: 合理安排种植时间，避免作物枯萎

### 进阶技巧
1. **变异优化**: 在高气运时种植，提高变异概率
2. **效率最大化**: 利用聚灵阵加速作物成长
3. **资源规划**: 平衡种子投入和材料产出

## 未来扩展

### 计划功能
- **更多作物**: 增加新的种子类型和收获物品
- **地块升级**: 允许玩家升级地块类型
- **自动化**: 自动种植和收获功能
- **社交功能**: 好友互助、种子交换

### 扩展方向
- **季节系统**: 不同季节影响作物成长
- **天气系统**: 天气变化影响种植效果
- **害虫防治**: 更复杂的地块管理机制
- **品种培育**: 通过杂交培育新品种

## 测试验证

### 功能测试
- ✅ 地块信息获取正常
- ✅ 种植功能正常
- ✅ 收获功能正常
- ✅ 解锁功能正常
- ✅ 变异机制正常
- ✅ 边界条件处理正确

### 界面测试
- ✅ 灵田窗口显示正常
- ✅ 地块状态更新及时
- ✅ 操作交互流畅
- ✅ 错误提示友好

## 总结

灵田系统作为游戏的重要功能模块，成功实现了以下目标：

1. **丰富游戏内容**: 为玩家提供了新的游戏玩法和目标
2. **材料获取渠道**: 通过种植获得修炼所需的材料
3. **策略性玩法**: 地块管理和作物选择需要策略思考
4. **长期目标**: 地块解锁和升级提供持续的游戏动力
5. **运气元素**: 变异机制增加了游戏的随机性和趣味性

灵田系统的成功实现为游戏增添了重要的深度和可玩性，与洞府系统、修炼系统形成了良好的功能互补，为玩家提供了更加完整和丰富的修仙体验。
