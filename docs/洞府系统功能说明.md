# 洞府系统功能说明

## 概述

洞府系统是气运修仙游戏的核心功能模块之一，为玩家提供了一个可升级的修炼场所。通过升级洞府和建造聚灵阵，玩家可以显著提升修炼效率，加快境界突破的进程。

## 核心功能

### 1. 洞府等级系统

#### 等级范围
- **等级范围**: 0-10级
- **初始等级**: 每个角色默认拥有0级洞府（无特殊功能）
- **升级方式**: 消耗灵石进行升级

#### 升级费用
| 目标等级 | 所需灵石 |
|---------|---------|
| 1级     | 500     |
| 2级     | 1,000   |
| 3级     | 2,000   |
| 4级     | 3,000   |
| 5级     | 4,000   |
| 6级     | 5,000   |
| 7级     | 6,000   |
| 8级     | 7,000   |
| 9级     | 8,000   |
| 10级    | 9,000   |

#### 等级功能解锁
| 洞府等级 | 解锁功能 | 突破失败损失率 |
|---------|---------|---------------|
| 0级     | 突破境界  | 20.0%         |
| 1级     | 无       | 19.0%         |
| 2级     | 无       | 18.0%         |
| 3级     | 聚灵阵   | 17.0%         |
| 4级     | 灵田     | 16.0%         |
| 5级     | 炼器房   | 15.0%         |
| 6级     | 藏书阁   | 14.0%         |
| 7级     | 传送阵   | 13.0%         |
| 8级     | 护山大阵  | 12.0%         |
| 9级     | 灵兽园   | 11.0%         |
| 10级    | 仙府升级  | 10.0%         |

### 2. 聚灵阵系统

#### 基本信息
- **等级范围**: 0-10级
- **解锁条件**: 洞府达到3级
- **主要作用**: 提升挂机修炼速度

#### 升级费用
| 目标等级 | 所需灵石 |
|---------|---------|
| 1级     | 500     |
| 2级     | 1,500   |
| 3级     | 4,000   |
| 4级     | 10,000  |
| 5级     | 25,000  |

#### 修炼速度加成
| 聚灵阵等级 | 修炼速度倍率 | 加成百分比 |
|-----------|-------------|-----------|
| 0级       | 1.0x        | 0%        |
| 1级       | 1.2x        | +20%      |
| 2级       | 1.5x        | +50%      |
| 3级       | 1.8x        | +80%      |
| 4级       | 2.2x        | +120%     |
| 5级       | 2.5x        | +150%     |

### 3. 境界突破功能

#### 功能描述
- 在洞府中可以安全地进行境界突破
- 突破成功率受气运值、灵根类型等因素影响
- 突破失败可能损失部分修为

#### 使用方式
1. 点击洞府界面的"境界突破"按钮
2. 系统显示当前突破成功率
3. 确认后执行突破判定
4. 显示突破结果

## 技术实现

### 数据库结构

#### Character表新增字段
```sql
cave_level INTEGER DEFAULT 0                    -- 洞府等级，默认0级
spirit_gathering_array_level INTEGER DEFAULT 0  -- 聚灵阵等级
```

### API接口

#### 获取洞府信息
- **端点**: `GET /api/v1/game/cave-info`
- **功能**: 获取当前角色的洞府详细信息
- **返回**: 洞府等级、聚灵阵等级、可用功能、升级费用等

#### 升级洞府/聚灵阵
- **端点**: `POST /api/v1/game/upgrade-cave`
- **参数**: `upgrade_type` ("cave" 或 "spirit_array")
- **功能**: 执行洞府或聚灵阵升级
- **返回**: 升级结果、消耗资源、新等级等

### 客户端界面

#### 洞府窗口 (CaveWindow)
- **文件位置**: `client/ui/windows/cave_window.py`
- **主要功能**:
  - 显示洞府基本信息
  - 洞府升级管理
  - 聚灵阵升级管理
  - 功能解锁状态展示
  - 修炼效果说明

#### 界面布局
- **左侧面板**: 洞府信息、升级功能、聚灵阵管理、功能列表
- **右侧面板**: 修炼效果信息、洞府说明文档

## 游戏平衡性

### 资源消耗设计
- **递增式费用**: 升级费用呈指数增长，确保后期升级具有挑战性
- **合理回报**: 聚灵阵的修炼速度加成与投入成本成正比
- **长期目标**: 满级洞府需要大量资源，提供长期游戏目标

### 功能解锁节奏
- **渐进式解锁**: 随洞府等级逐步解锁新功能
- **核心功能优先**: 修炼相关功能在低等级即可解锁
- **高级功能**: 后期功能为未来扩展预留空间

## 使用指南

### 新手指导
1. **初期目标**: 0级洞府已可突破，但损失率最高(20%)
2. **第一目标**: 升级到1级减少突破损失(19%)
3. **第二目标**: 升级到3级解锁聚灵阵，提升修炼效率
4. **资源分配**: 平衡洞府和聚灵阵的升级投入
5. **效益最大化**: 聚灵阵1-2级性价比最高
6. **突破保护**: 洞府等级越高，突破失败损失越少

### 进阶策略
1. **长期规划**: 根据灵石获取速度制定升级计划
2. **优先级**: 聚灵阵升级优先于洞府等级提升
3. **成本效益**: 计算升级成本与修炼效率提升的比值

## 未来扩展

### 计划功能
- **丹房系统**: 3级洞府解锁，提升炼丹成功率
- **灵田系统**: 4级洞府解锁，种植灵草药材
- **炼器房**: 5级洞府解锁，制作和强化装备
- **藏书阁**: 6级洞府解锁，学习功法技能

### 扩展方向
- **洞府装饰**: 个性化洞府外观
- **访客系统**: 好友互访洞府功能
- **洞府防护**: 护山大阵等防御机制
- **灵兽系统**: 洞府内饲养灵兽

## 测试验证

### 功能测试
- ✅ 洞府信息获取正常
- ✅ 洞府升级功能正常
- ✅ 聚灵阵升级功能正常
- ✅ 修炼速度加成生效
- ✅ 边界条件处理正确

### 界面测试
- ✅ 洞府窗口显示正常
- ✅ 升级按钮交互正常
- ✅ 信息更新及时准确
- ✅ 错误提示友好清晰

## 总结

洞府系统作为游戏的核心功能模块，成功实现了以下目标：

1. **提升游戏深度**: 为玩家提供了可持续的升级目标
2. **增强修炼体验**: 通过聚灵阵显著提升修炼效率
3. **平衡游戏节奏**: 合理的升级成本控制游戏进程
4. **预留扩展空间**: 为未来功能模块提供了良好的基础

洞府系统的成功实现标志着游戏核心玩法的进一步完善，为玩家提供了更加丰富和深入的修仙体验。
